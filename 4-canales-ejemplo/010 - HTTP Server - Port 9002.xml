<channel version="4.5.2">
  <id>0a24f6d4-6832-49b2-b70c-225e9451a1ae</id>
  <nextMetaDataId>2</nextMetaDataId>
  <name>010 - HTTP Server - Port 9002</name>
  <description></description>
  <revision>2</revision>
  <sourceConnector version="4.5.2">
    <metaDataId>0</metaDataId>
    <name>sourceConnector</name>
    <properties class="com.mirth.connect.connectors.http.HttpReceiverProperties" version="4.5.2">
      <pluginProperties>
        <com.mirth.connect.plugins.httpauth.NoneHttpAuthProperties version="4.5.2">
  <authType>NONE</authType>
        </com.mirth.connect.plugins.httpauth.NoneHttpAuthProperties>
      </pluginProperties>
      <listenerConnectorProperties version="4.5.2">
        <host>0.0.0.0</host>
        <port>9002</port>
      </listenerConnectorProperties>
      <sourceConnectorProperties version="4.5.2">
        <responseVariable>d1</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>false</processBatch>
        <firstResponse>false</firstResponse>
        <processingThreads>1</processingThreads>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
        <queueBufferSize>1000</queueBufferSize>
      </sourceConnectorProperties>
      <xmlBody>false</xmlBody>
      <parseMultipart>true</parseMultipart>
      <includeMetadata>false</includeMetadata>
      <binaryMimeTypes>application/.*(?&lt;!json|xml)$|image/.*|video/.*|audio/.*</binaryMimeTypes>
      <binaryMimeTypesRegex>true</binaryMimeTypesRegex>
      <responseContentType>application/json</responseContentType>
      <responseDataTypeBinary>false</responseDataTypeBinary>
      <responseStatusCode>200</responseStatusCode>
      <responseHeaders class="linked-hash-map"/>
      <responseHeadersVariable></responseHeadersVariable>
      <useResponseHeadersVariable>false</useResponseHeadersVariable>
      <charset>UTF-8</charset>
      <contextPath>base</contextPath>
      <timeout>30000</timeout>
      <staticResources/>
    </properties>
    <transformer version="4.5.2">
      <elements>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.2">
          <sequenceNumber>0</sequenceNumber>
          <enabled>false</enabled>
          <script>/**
 * HTTP Listener (Inbound RAW JSON):
 *   { &quot;hl7Message&quot;: &quot;MSH|^~\\&amp;|...\\rPID|...\\r&quot; }
 *
 * Steps:
 *  1) Extract hl7Message
 *  2) Deserialize HL7 ER7 -&gt; XML using SerializerFactory
 *  3) Build HL7 ACK (ER7) and respond JSON with embedded ACK
 *
 * IMPORTANT:
 * - Put this as the LAST step in Source Transformer (so nobody overwrites msg).
 * - HTTP Listener Response = Auto-generate (After source transformer)
 *   so the HTTP response body will be `msg` at the end.
 */

// -------------------------
// Helpers
// -------------------------
function safeStr(v) { return (v === null || v === undefined) ? &quot;&quot; : String(v); }
function pad2(n) { return (n &lt; 10 ? &quot;0&quot; : &quot;&quot;) + n; }
function tsNow() {
  var d = new Date();
  return &quot;&quot;
    + d.getFullYear()
    + pad2(d.getMonth() + 1)
    + pad2(d.getDate())
    + pad2(d.getHours())
    + pad2(d.getMinutes())
    + pad2(d.getSeconds());
}

/**
 * Build an ACK (ER7) using encoding chars from the original message when possible.
 * We keep it minimal: MSH + MSA.
 */
function buildAckER7(encChars, originalControlId, ackCode, text) {
  var dtm = tsNow();
  var msh =
    &quot;MSH|&quot; + encChars
    + &quot;|MIRTH|HTTP-LISTENER&quot;
    + &quot;|CLIENT|HTTP-SENDER&quot;
    + &quot;|&quot; + dtm
    + &quot;||ACK^A01^ACK&quot;
    + &quot;|ACK-&quot; + dtm
    + &quot;|P|2.5.1&quot;;

  var msa =
    &quot;MSA|&quot; + (ackCode || &quot;AA&quot;)
    + &quot;|&quot; + safeStr(originalControlId)
    + (text ? (&quot;|&quot; + text) : &quot;&quot;);

  return msh + &quot;\r&quot; + msa + &quot;\r&quot;;
}

// -------------------------
// 1) Extract hl7Message from JSON
// -------------------------
var rawJson = safeStr(msg);
channelMap.put(&quot;requestRawJson&quot;, rawJson);

var payload;
try {
  payload = JSON.parse(rawJson);
} catch (e) {
  // JSON inválido -&gt; responder error + ACK AE
  var ackBadJson = buildAckER7(&quot;^~\\&amp;&quot;, &quot;&quot;, &quot;AE&quot;, &quot;Invalid JSON&quot;);
  var bodyBadJson = JSON.stringify({
    status: &quot;ERROR&quot;,
    error: &quot;Invalid JSON&quot;,
    received: new Date().toISOString(),
    ack: ackBadJson
  });

  responseMap.put(&quot;responseStatusCode&quot;, &quot;400&quot;);
  responseMap.put(&quot;responseContentType&quot;, &quot;application/json; charset=UTF-8&quot;);
  msg = bodyBadJson;
  return;
}

var hl7 = safeStr(payload.hl7Message);
channelMap.put(&quot;hl7In&quot;, hl7);

if (!hl7) {
  var ackNoMsg = buildAckER7(&quot;^~\\&amp;&quot;, &quot;&quot;, &quot;AE&quot;, &quot;Missing hl7Message&quot;);
  var bodyNoMsg = JSON.stringify({
    status: &quot;ERROR&quot;,
    error: &quot;Missing hl7Message&quot;,
    received: new Date().toISOString(),
    ack: ackNoMsg
  });

  responseMap.put(&quot;responseStatusCode&quot;, &quot;400&quot;);
  responseMap.put(&quot;responseContentType&quot;, &quot;application/json; charset=UTF-8&quot;);
  msg = bodyNoMsg;
  return;
}

// -------------------------
// 2) Deserialize HL7 ER7 -&gt; XML using SerializerFactory
// -------------------------
var dataType = &quot;HL7V2&quot;;
var serProps = SerializerFactory.getDefaultSerializationProperties(dataType);
var deserProps = SerializerFactory.getDefaultDeserializationProperties(dataType);
var serializer = SerializerFactory.getSerializer(dataType, serProps, deserProps);

var hl7Xml;
try {
  hl7Xml = serializer.toXML(hl7); // ER7 -&gt; XML internal model
} catch (e2) {
  // HL7 inválido -&gt; responder AE
  var ackBadHl7 = buildAckER7(&quot;^~\\&amp;&quot;, &quot;&quot;, &quot;AE&quot;, &quot;Invalid HL7&quot;);
  var bodyBadHl7 = JSON.stringify({
    status: &quot;ERROR&quot;,
    error: &quot;Invalid HL7 (cannot deserialize)&quot;,
    details: safeStr(e2),
    received: new Date().toISOString(),
    ack: ackBadHl7
  });

  responseMap.put(&quot;responseStatusCode&quot;, &quot;400&quot;);
  responseMap.put(&quot;responseContentType&quot;, &quot;application/json; charset=UTF-8&quot;);
  msg = bodyBadHl7;
  return;
}

// Extraer MSH-10 desde XML (control id del mensaje original)
var originalControlId = &quot;&quot;;
try {
  // En el modelo XML de Mirth, MSH.10 suele estar en xml[&apos;MSH&apos;][&apos;MSH.10&apos;]
  originalControlId = safeStr(hl7Xml[&apos;MSH&apos;][&apos;MSH.10&apos;]);
} catch (e3) {
  originalControlId = &quot;&quot;;
}

// Extraer encoding chars desde el HL7 original usando MSH-2 si está
// Nota: Serializer no siempre expone MSH-2 directo como string útil; el método más fiable:
// leerlo desde el ER7 (solo MSH) o default ^~\&amp;
var encChars = &quot;^~\\&amp;&quot;;
try {
  // si existe MSH.2 en XML úsalo; si no, deja default
  var msh2 = safeStr(hl7Xml[&apos;MSH&apos;][&apos;MSH.2&apos;]);
  if (msh2) encChars = msh2;
} catch (e4) {
  // keep default
}

channelMap.put(&quot;originalControlId&quot;, originalControlId);

// -------------------------
// 3) Construct ACK and respond JSON with embedded ACK
// -------------------------
var ackCode = &quot;AA&quot;;
var ackText = &quot;&quot;;

// (opcional) si no hay control ID, igual responde AA pero lo dejamos vacío.
// Si quieres ser más estricto, cambia a AE.
if (!originalControlId) {
  // ackCode = &quot;AE&quot;;
  // ackText = &quot;Missing MSH-10&quot;;
}

var ackEr7 = buildAckER7(encChars, originalControlId, ackCode, ackText);
channelMap.put(&quot;ackEr7&quot;, ackEr7);

var responseObj = {
  status: (ackCode === &quot;AA&quot;) ? &quot;OK&quot; : &quot;ERROR&quot;,
  received: new Date().toISOString(),
  controlId: originalControlId,
  ack: ackEr7
};

var responseJson = JSON.stringify(responseObj);

// HTTP response headers/status
responseMap.put(&quot;responseStatusCode&quot;, (ackCode === &quot;AA&quot;) ? &quot;200&quot; : &quot;400&quot;);
responseMap.put(&quot;responseContentType&quot;, &quot;application/json; charset=UTF-8&quot;);

// Body: Auto-generate uses final msg
msg = responseJson;</script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.2">
          <sequenceNumber>1</sequenceNumber>
          <enabled>true</enabled>
          <script>msg = JSON.stringify({ status: &quot;OK&quot; });</script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundTemplate encoding="base64">eyAiaGw3TWVzc2FnZSI6ICJNU0h8Xn5cJnxNSVJUSHxDTElOSUN8RUhSfEhPU1BJVEFMfDIwMjYwMTEzMTY1NzU1fHxBRFReQTAxXkFEVF9BMDF8QURUMjAyNjAxMTMxNjU3NTUtNTA2MDB8UHwyLjUuMVxyRVZOfEEwMXwyMDI2MDExMzE2NTc1NVxyUElEfDF8fDEyMzQ1Xl5eQ0xJTklDXk1SfHxQZXJlel5KdWFuXl5eXnx8MTk4MDA1MjB8TVxyUFYxfDF8RXxFUl5eXk1BSU5eXl5CMV58fHx8TUVEMTIzXkhvdXNlXkdyZWdvcnleXl5eXnx8fHx8fHx8fHx8Vk4wMDAxXl5eQ0xJTklDXlZOIgp9</inboundTemplate>
      <outboundTemplate encoding="base64"></outboundTemplate>
      <inboundDataType>JSON</inboundDataType>
      <outboundDataType>JSON</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.json.JSONDataTypeProperties" version="4.5.2">
        <batchProperties class="com.mirth.connect.plugins.datatypes.json.JSONBatchProperties" version="4.5.2">
          <splitType>JavaScript</splitType>
          <batchScript></batchScript>
        </batchProperties>
      </inboundProperties>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.json.JSONDataTypeProperties" version="4.5.2">
        <batchProperties class="com.mirth.connect.plugins.datatypes.json.JSONBatchProperties" version="4.5.2">
          <splitType>JavaScript</splitType>
          <batchScript></batchScript>
        </batchProperties>
      </outboundProperties>
    </transformer>
    <filter version="4.5.2">
      <elements/>
    </filter>
    <transportName>HTTP Listener</transportName>
    <mode>SOURCE</mode>
    <enabled>true</enabled>
    <waitForPrevious>true</waitForPrevious>
  </sourceConnector>
  <destinationConnectors>
    <connector version="4.5.2">
      <metaDataId>1</metaDataId>
      <name>Destination 1</name>
      <properties class="com.mirth.connect.connectors.js.JavaScriptDispatcherProperties" version="4.5.2">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.2">
          <queueEnabled>false</queueEnabled>
          <sendFirst>false</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>0</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>1</threadCount>
          <threadAssignmentVariable></threadAssignmentVariable>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <script>return connectorMessage.getEncodedData();</script>
      </properties>
      <transformer version="4.5.2">
        <elements/>
        <inboundDataType>JSON</inboundDataType>
        <outboundDataType>JSON</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.json.JSONDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.json.JSONBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.json.JSONDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.json.JSONBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </outboundProperties>
      </transformer>
      <responseTransformer version="4.5.2">
        <elements>
          <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.2">
            <sequenceNumber>0</sequenceNumber>
            <enabled>true</enabled>
            <script></script>
          </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
        </elements>
        <inboundTemplate encoding="base64"></inboundTemplate>
        <outboundTemplate encoding="base64"></outboundTemplate>
        <inboundDataType>JSON</inboundDataType>
        <outboundDataType>JSON</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.json.JSONDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.json.JSONBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.json.JSONDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.json.JSONBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </outboundProperties>
      </responseTransformer>
      <filter version="4.5.2">
        <elements/>
      </filter>
      <transportName>JavaScript Writer</transportName>
      <mode>DESTINATION</mode>
      <enabled>true</enabled>
      <waitForPrevious>true</waitForPrevious>
    </connector>
  </destinationConnectors>
  <preprocessingScript>// Modify the message variable below to pre process data
return message;</preprocessingScript>
  <postprocessingScript>// This script executes once after a message has been processed
// Responses returned from here will be stored as &quot;Postprocessor&quot; in the response map
return;</postprocessingScript>
  <deployScript>// This script executes once when the channel is deployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</deployScript>
  <undeployScript>// This script executes once when the channel is undeployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</undeployScript>
  <properties version="4.5.2">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>DEVELOPMENT</messageStorageMode>
    <encryptData>false</encryptData>
    <encryptAttachments>false</encryptAttachments>
    <encryptCustomMetaData>false</encryptCustomMetaData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>true</storeAttachments>
    <metaDataColumns>
      <metaDataColumn>
        <name>SOURCE</name>
        <type>STRING</type>
        <mappingName>mirth_source</mappingName>
      </metaDataColumn>
      <metaDataColumn>
        <name>TYPE</name>
        <type>STRING</type>
        <mappingName>mirth_type</mappingName>
      </metaDataColumn>
    </metaDataColumns>
    <attachmentProperties version="4.5.2">
      <type>None</type>
      <properties/>
    </attachmentProperties>
    <resourceIds class="linked-hash-map">
      <entry>
        <string>Default Resource</string>
        <string>[Default Resource]</string>
      </entry>
    </resourceIds>
  </properties>
  <exportData>
    <metadata>
      <enabled>true</enabled>
      <lastModified>
        <time>1769445724474</time>
        <timezone>America/Santiago</timezone>
      </lastModified>
      <pruningSettings>
        <archiveEnabled>true</archiveEnabled>
        <pruneErroredMessages>false</pruneErroredMessages>
      </pruningSettings>
      <userId>1</userId>
    </metadata>
    <dependentIds>
      <string>7634f73d-cf74-4d92-9d7e-c93022f28832</string>
    </dependentIds>
  </exportData>
</channel>