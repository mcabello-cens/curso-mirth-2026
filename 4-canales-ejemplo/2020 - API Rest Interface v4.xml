<channel version="4.5.2">
  <id>7c826555-a4e8-46e5-b749-1e099eefb742</id>
  <nextMetaDataId>2</nextMetaDataId>
  <name>2020 - API Rest Interface v4</name>
  <description></description>
  <revision>1</revision>
  <sourceConnector version="4.5.2">
    <metaDataId>0</metaDataId>
    <name>sourceConnector</name>
    <properties class="com.mirth.connect.connectors.http.HttpReceiverProperties" version="4.5.2">
      <pluginProperties>
        <com.mirth.connect.plugins.httpauth.NoneHttpAuthProperties version="4.5.2">
  <authType>NONE</authType>
        </com.mirth.connect.plugins.httpauth.NoneHttpAuthProperties>
      </pluginProperties>
      <listenerConnectorProperties version="4.5.2">
        <host>0.0.0.0</host>
        <port>9002</port>
      </listenerConnectorProperties>
      <sourceConnectorProperties version="4.5.2">
        <responseVariable>response</responseVariable>
        <respondAfterProcessing>true</respondAfterProcessing>
        <processBatch>false</processBatch>
        <firstResponse>false</firstResponse>
        <processingThreads>1</processingThreads>
        <resourceIds class="linked-hash-map">
          <entry>
            <string>Default Resource</string>
            <string>[Default Resource]</string>
          </entry>
        </resourceIds>
        <queueBufferSize>1000</queueBufferSize>
      </sourceConnectorProperties>
      <xmlBody>false</xmlBody>
      <parseMultipart>true</parseMultipart>
      <includeMetadata>false</includeMetadata>
      <binaryMimeTypes>application/.*(?&lt;!json|xml)$|image/.*|video/.*|audio/.*</binaryMimeTypes>
      <binaryMimeTypesRegex>true</binaryMimeTypesRegex>
      <responseContentType>${responseContentType}</responseContentType>
      <responseDataTypeBinary>false</responseDataTypeBinary>
      <responseStatusCode>${responseStatusCode}</responseStatusCode>
      <responseHeaders class="linked-hash-map"/>
      <responseHeadersVariable></responseHeadersVariable>
      <useResponseHeadersVariable>false</useResponseHeadersVariable>
      <charset>UTF-8</charset>
      <contextPath>base</contextPath>
      <timeout>30000</timeout>
      <staticResources>
        <com.mirth.connect.connectors.http.HttpStaticResource>
          <contextPath>/about</contextPath>
          <resourceType>CUSTOM</resourceType>
          <value>{
  &quot;name&quot;: &quot;Mi API Mirth&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;status&quot;: &quot;ok&quot;
}
</value>
          <contentType>application/json</contentType>
        </com.mirth.connect.connectors.http.HttpStaticResource>
      </staticResources>
    </properties>
    <transformer version="4.5.2">
      <elements>
        <com.mirth.connect.plugins.javascriptstep.JavaScriptStep version="4.5.2">
          <sequenceNumber>0</sequenceNumber>
          <enabled>true</enabled>
          <script>logger.info(&quot;=== HTTP DEBUG: sourceMap keys (http/uri/path) ===&quot;);
try {
  var it = sourceMap.keySet().iterator();
  while (it.hasNext()) {
    var k = String(it.next());
    var kl = k.toLowerCase();
    if (kl.indexOf(&quot;http&quot;) &gt;= 0 || kl.indexOf(&quot;uri&quot;) &gt;= 0 || kl.indexOf(&quot;path&quot;) &gt;= 0 || kl.indexOf(&quot;request&quot;) &gt;= 0) {
      logger.info(&quot;HTTP DEBUG &quot; + k + &quot; = &quot; + String(sourceMap.get(k)));
    }
  }
} catch (e) {
  logger.error(&quot;HTTP DEBUG dump error: &quot; + e);
}

// =======================
// Helpers
// =======================
function s(v){ return v == null ? &quot;&quot; : String(v); }

function normalizePath(p) {
  if (p == null) return &quot;&quot;;
  p = String(p).trim();

  // quita querystring
  var q = p.indexOf(&quot;?&quot;);
  if (q &gt;= 0) p = p.substring(0, q);

  // quita slash final
  if (p.length &gt; 1 &amp;&amp; p.charAt(p.length - 1) === &quot;/&quot;) {
    p = p.substring(0, p.length - 1);
  }
  return p;
}

// Convierte &quot;/base/pacientes&quot; -&gt; &quot;/pacientes&quot;
// Convierte &quot;/base&quot; -&gt; &quot;/&quot;
function stripBase(p, base) {
  p = normalizePath(p);
  base = normalizePath(base);

  if (p === &quot;&quot;) return &quot;&quot;;
  if (base === &quot;&quot;) return p;

  if (p === base) return &quot;/&quot;;

  if (p.indexOf(base + &quot;/&quot;) === 0) {
    return p.substring(base.length); // deja &quot;/pacientes&quot;
  }

  // si ya viene sin base
  return p;
}

function getMethodSafe() {
  // En tu caso puede no venir; para GET basta default
  // Si más adelante agregas POST, dump de sourceMap y ajustamos.
  try { return String(request.getMethod()).toUpperCase(); } catch (e) {}
  var m = s(sourceMap.get(&quot;method&quot;));
  return (m ? m.toUpperCase() : &quot;GET&quot;);
}

function getUriFromSourceMap() {
  // Confirmado por tu log: sourceMap trae &quot;uri&quot;
  var u = s(sourceMap.get(&quot;uri&quot;));
  if (u) return u;

  // fallback por si cambia
  u = s(sourceMap.get(&quot;contextPath&quot;));
  if (u) return u;

  return &quot;&quot;;
}

function sendJson(statusCode, obj) {
  // responseMap.put(&quot;response&quot;, JSON.stringify(obj));
  responseMap.put(&quot;response&quot;, JSON.stringify(obj, null, 2));


  // Solo úsalo si tu HTTP Listener tiene un campo/ítem que lea ${responseStatusCode}.
  // Si no lo tiene, no pasa nada; responde 200 por defecto.
  channelMap.put(&quot;responseStatusCode&quot;, String(statusCode));
}

// =======================
// Handlers
// =======================
function root(ctx) {
  return {
    status: 200,
    body: {
      name: &quot;API Rest Interface&quot;,
      base: &quot;/base&quot;,
      endpoints: [&quot;/base/pacientes&quot;, &quot;/base/medicos&quot;, &quot;/base/about&quot;]
    }
  };
}

function listPacientes(ctx) {
  return {
    status: 200,
    body: [
      { id: &quot;P001&quot;, nombre: &quot;Ana Pérez&quot;, edad: 31 },
      { id: &quot;P002&quot;, nombre: &quot;Juan Soto&quot;, edad: 45 }
    ]
  };
}

function listMedicos(ctx) {
  return {
    status: 200,
    body: [
      { id: &quot;M001&quot;, nombre: &quot;Dra. Ruiz&quot;, especialidad: &quot;Medicina Interna&quot; },
      { id: &quot;M002&quot;, nombre: &quot;Dr. Muñoz&quot;, especialidad: &quot;Cardiología&quot; }
    ]
  };
}

function notFound(ctx) {
  return {
    status: 404,
    body: {
      error: &quot;Not Found&quot;,
      path: ctx.path,
      uri: ctx.uri,
      hint: &quot;Try /base/pacientes, /base/medicos, /base/about&quot;
    }
  };
}

function methodNotAllowed(ctx, allowed) {
  return {
    status: 405,
    body: { error: &quot;Method Not Allowed&quot;, method: ctx.method, allowed: allowed }
  };
}

// =======================
// Router (paths SIN /base)
// =======================
var router = {
  &quot;/&quot;:          { &quot;GET&quot;: root },
  &quot;/pacientes&quot;: { 
  	&quot;GET&quot;:  listPacientes,
     &quot;POST&quot;: createPaciente },
  &quot;/medicos&quot;:   { &quot;GET&quot;: listMedicos }
};

// =======================
// Main
// =======================
var base = &quot;/base&quot;;
var method = getMethodSafe();
var uri = normalizePath(getUriFromSourceMap());   // &quot;/base/medicos&quot;
var path = stripBase(uri, base);                  // &quot;/medicos&quot;

logger.info(&quot;HTTP DEBUG method=&quot; + method + &quot; uri=&quot; + uri + &quot; path=&quot; + path);

var ctx = { method: method, uri: uri, path: path };

var route = router[path];
if (!route) {
  var r404 = notFound(ctx);
  sendJson(r404.status, r404.body);
} else {
  var handler = route[method];
  if (!handler) {
    var allowed = [];
    for (var m in route) allowed.push(m);
    var r405 = methodNotAllowed(ctx, allowed);
    sendJson(r405.status, r405.body);
  } else {
    try {
      var result = handler(ctx);
      sendJson(result.status, result.body);
    } catch (e) {
      sendJson(500, { error: &quot;Internal Server Error&quot;, details: String(e) });
    }
  }
}





function getBodySafe() {
  // 1) Intenta con las keys más comunes en sourceMap
  var candidates = [
    sourceMap.get(&apos;rawData&apos;),
    sourceMap.get(&apos;body&apos;),
    sourceMap.get(&apos;postData&apos;),
    sourceMap.get(&apos;content&apos;),
    sourceMap.get(&apos;message&apos;),
    sourceMap.get(&apos;data&apos;)
  ];

  for (var i = 0; i &lt; candidates.length; i++) {
    var v = candidates[i];
    if (v != null) {
      var s = String(v);
      if (s.length &gt; 0) return s;
    }
  }

  // 2) Fallback: lo que realmente recibió el connector
  try {
    var rd = connectorMessage.getRawData();
    if (rd != null) {
      // A veces viene como byte[]
      if (rd.getClass &amp;&amp; String(rd.getClass().getName()) === &quot;[B&quot;) {
        return new java.lang.String(rd, &quot;UTF-8&quot;);
      }
      var s2 = String(rd);
      if (s2.length &gt; 0) return s2;
    }
  } catch (e) {}

  // 3) Último fallback: transformed data
  try {
    var td = connectorMessage.getTransformedData();
    if (td != null) {
      var s3 = String(td);
      if (s3.length &gt; 0) return s3;
    }
  } catch (e2) {}

  return &quot;&quot;;
}




function createPaciente(ctx) {

  var raw = getBodySafe();
  logger.info(&quot;POST body len=&quot; + (raw ? raw.length : 0));
  logger.info(&quot;POST body preview=&quot; + (raw ? raw.substring(0, Math.min(200, raw.length)) : &quot;&lt;empty&gt;&quot;));

  if (!raw) {
    return { status: 400, body: { error: &quot;Empty body&quot; } };
  }

  var data;
  try {
    data = JSON.parse(raw);
  } catch (e) {
    return { status: 400, body: { error: &quot;Invalid JSON&quot;, details: String(e) } };
  }

  // Validación básica (no seas tímido aquí)
  if (!data.nombre || !data.edad) {
    return {
      status: 400,
      body: {
        error: &quot;Missing fields&quot;,
        required: [&quot;nombre&quot;, &quot;edad&quot;]
      }
    };
  }

  // Simulación de ID generado
  var newId = &quot;P&quot; + Math.floor(Math.random() * 10000);

  var paciente = {
    id: newId,
    nombre: data.nombre,
    edad: data.edad
  };

  logger.info(&quot;Paciente creado: &quot; + JSON.stringify(paciente));

  return {
    status: 201,
    body: paciente
  };
}</script>
        </com.mirth.connect.plugins.javascriptstep.JavaScriptStep>
      </elements>
      <inboundTemplate encoding="base64"></inboundTemplate>
      <outboundTemplate encoding="base64"></outboundTemplate>
      <inboundDataType>RAW</inboundDataType>
      <outboundDataType>RAW</outboundDataType>
      <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties" version="4.5.2">
        <batchProperties class="com.mirth.connect.plugins.datatypes.raw.RawBatchProperties" version="4.5.2">
          <splitType>JavaScript</splitType>
          <batchScript></batchScript>
        </batchProperties>
      </inboundProperties>
      <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties" version="4.5.2">
        <batchProperties class="com.mirth.connect.plugins.datatypes.raw.RawBatchProperties" version="4.5.2">
          <splitType>JavaScript</splitType>
          <batchScript></batchScript>
        </batchProperties>
      </outboundProperties>
    </transformer>
    <filter version="4.5.2">
      <elements/>
    </filter>
    <transportName>HTTP Listener</transportName>
    <mode>SOURCE</mode>
    <enabled>true</enabled>
    <waitForPrevious>true</waitForPrevious>
  </sourceConnector>
  <destinationConnectors>
    <connector version="4.5.2">
      <metaDataId>1</metaDataId>
      <name>Destination 1</name>
      <properties class="com.mirth.connect.connectors.js.JavaScriptDispatcherProperties" version="4.5.2">
        <pluginProperties/>
        <destinationConnectorProperties version="4.5.2">
          <queueEnabled>false</queueEnabled>
          <sendFirst>false</sendFirst>
          <retryIntervalMillis>10000</retryIntervalMillis>
          <regenerateTemplate>false</regenerateTemplate>
          <retryCount>0</retryCount>
          <rotate>false</rotate>
          <includeFilterTransformer>false</includeFilterTransformer>
          <threadCount>1</threadCount>
          <threadAssignmentVariable></threadAssignmentVariable>
          <validateResponse>false</validateResponse>
          <resourceIds class="linked-hash-map">
            <entry>
              <string>Default Resource</string>
              <string>[Default Resource]</string>
            </entry>
          </resourceIds>
          <queueBufferSize>1000</queueBufferSize>
          <reattachAttachments>true</reattachAttachments>
        </destinationConnectorProperties>
        <script>logger.info(&quot;hecho&quot;);</script>
      </properties>
      <transformer version="4.5.2">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.raw.RawBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.raw.RawBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </outboundProperties>
      </transformer>
      <responseTransformer version="4.5.2">
        <elements/>
        <inboundDataType>RAW</inboundDataType>
        <outboundDataType>RAW</outboundDataType>
        <inboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.raw.RawBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </inboundProperties>
        <outboundProperties class="com.mirth.connect.plugins.datatypes.raw.RawDataTypeProperties" version="4.5.2">
          <batchProperties class="com.mirth.connect.plugins.datatypes.raw.RawBatchProperties" version="4.5.2">
            <splitType>JavaScript</splitType>
            <batchScript></batchScript>
          </batchProperties>
        </outboundProperties>
      </responseTransformer>
      <filter version="4.5.2">
        <elements/>
      </filter>
      <transportName>JavaScript Writer</transportName>
      <mode>DESTINATION</mode>
      <enabled>true</enabled>
      <waitForPrevious>true</waitForPrevious>
    </connector>
  </destinationConnectors>
  <preprocessingScript>// Modify the message variable below to pre process data
return message;</preprocessingScript>
  <postprocessingScript>// This script executes once after a message has been processed
// Responses returned from here will be stored as &quot;Postprocessor&quot; in the response map

return;</postprocessingScript>
  <deployScript>// This script executes once when the channel is deployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</deployScript>
  <undeployScript>// This script executes once when the channel is undeployed
// You only have access to the globalMap and globalChannelMap here to persist data
return;</undeployScript>
  <properties version="4.5.2">
    <clearGlobalChannelMap>true</clearGlobalChannelMap>
    <messageStorageMode>DEVELOPMENT</messageStorageMode>
    <encryptData>false</encryptData>
    <encryptAttachments>false</encryptAttachments>
    <encryptCustomMetaData>false</encryptCustomMetaData>
    <removeContentOnCompletion>false</removeContentOnCompletion>
    <removeOnlyFilteredOnCompletion>false</removeOnlyFilteredOnCompletion>
    <removeAttachmentsOnCompletion>false</removeAttachmentsOnCompletion>
    <initialState>STARTED</initialState>
    <storeAttachments>false</storeAttachments>
    <metaDataColumns>
      <metaDataColumn>
        <name>SOURCE</name>
        <type>STRING</type>
        <mappingName>mirth_source</mappingName>
      </metaDataColumn>
      <metaDataColumn>
        <name>TYPE</name>
        <type>STRING</type>
        <mappingName>mirth_type</mappingName>
      </metaDataColumn>
    </metaDataColumns>
    <attachmentProperties version="4.5.2">
      <type>None</type>
      <properties/>
    </attachmentProperties>
    <resourceIds class="linked-hash-map">
      <entry>
        <string>Default Resource</string>
        <string>[Default Resource]</string>
      </entry>
    </resourceIds>
  </properties>
  <exportData>
    <metadata>
      <enabled>true</enabled>
      <lastModified>
        <time>1769385785028</time>
        <timezone>America/Santiago</timezone>
      </lastModified>
    </metadata>
    <channelTags>
      <channelTag>
        <id>b29a759a-79f8-45af-ab56-ee5a1b770367</id>
        <name>hard</name>
        <channelIds>
          <string>881a6aef-8f85-4a61-b07e-47f556a91655</string>
          <string>0db27dec-a4ae-44ab-a03d-e278f25eb894</string>
          <string>7c826555-a4e8-46e5-b749-1e099eefb742</string>
          <string>f5066aba-9341-4927-a952-451a197b076c</string>
          <string>f41d1823-91e7-4c85-bbce-961e3a34be06</string>
          <string>9794ee2e-2fec-4cfc-84a9-cf024ce23a54</string>
          <string>c36331d6-959d-430f-a502-437161f1fbab</string>
        </channelIds>
        <backgroundColor>
          <red>255</red>
          <green>0</green>
          <blue>51</blue>
          <alpha>255</alpha>
        </backgroundColor>
      </channelTag>
      <channelTag>
        <id>990d1c33-74c6-45e7-9278-fadfa91a8c43</id>
        <name>REST</name>
        <channelIds>
          <string>4c783b83-4620-4d9f-9d0d-ab68ad92a4fa</string>
          <string>881a6aef-8f85-4a61-b07e-47f556a91655</string>
          <string>7c826555-a4e8-46e5-b749-1e099eefb742</string>
          <string>1e61610b-a229-44da-bb44-7888dc780213</string>
          <string>e610d5a0-33a1-4da0-ac05-d0597733e3bb</string>
        </channelIds>
        <backgroundColor>
          <red>255</red>
          <green>255</green>
          <blue>0</blue>
          <alpha>255</alpha>
        </backgroundColor>
      </channelTag>
    </channelTags>
  </exportData>
</channel>